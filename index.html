<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scratch Card Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <style>
    body { margin: 0; background: #f0f0f0; font-family: Arial; text-align: center; }
    canvas { border: 2px solid #333; background: #ccc; cursor: pointer; }
    #result { margin-top: 20px; font-size: 20px; color: green; }
  </style>
</head>
<body>
  <h2>Scratch the Card!</h2>
  <canvas id="scratch" width="300" height="200"></canvas>
  <div id="result"></div>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const canvas = document.getElementById('scratch');
    const ctx = canvas.getContext('2d');
    const resultDiv = document.getElementById('result');

    const urlParams = new URLSearchParams(window.location.search);
    const price = parseFloat(urlParams.get('price')) || 0.01;
    const theme = urlParams.get('theme') || 'FTX Collapse Card';

    let multiplier = 'No Win This Time.';
    let win = '0';

    async function init() {
      if (window.solana && window.solana.isPhantom) {
        try {
          const response = await window.solana.connect();
          const userWallet = response.publicKey.toString();

          const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com', 'confirmed');
          const housePubkey = new solanaWeb3.PublicKey('EkxrH4sq9ezE2EQQcNpB3SxdkfNJvnzfZt9YN799MCPF');

          const transaction = new solanaWeb3.Transaction();

          transaction.add(
            solanaWeb3.SystemProgram.transfer({
              fromPubkey: response.publicKey,
              toPubkey: housePubkey,
              lamports: price * solanaWeb3.LAMPORTS_PER_SOL,
            })
          );

          transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
          transaction.feePayer = response.publicKey;

          const { signature } = await window.solana.signAndSendTransaction(transaction);
          await connection.confirmTransaction({ signature, commitment: 'confirmed' });

          // Call API for outcome
          const apiResponse = await fetch('https://vallecular-imputatively-memphis.ngrok-free.dev/get-outcome', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ txSig: signature, theme, userAddress: userWallet })
          });
          const data = await apiResponse.json();
          multiplier = data.multiplier;
          win = data.win;

          // Draw dynamic outcome
          ctx.fillStyle = '#fff';
          ctx.fillRect(0, 0, 300, 200);
          ctx.fillStyle = '#000';
          ctx.font = '20px Arial';
          ctx.fillText(`${multiplier} Win: ${win} SOL`, 50, 100);

          // Scratch layer
          ctx.fillStyle = '#999';
          ctx.fillRect(0, 0, 300, 200);
        } catch (err) {
          alert('Payment or API failed: ' + err.message);
          tg.close();
        }
      } else {
        alert('Install Phantom wallet!');
        tg.close();
      }
    }

    init(); // Start payment on load

    let scratching = false;

    const scratch = (x, y) => {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(x, y, 15, 0, Math.PI * 2);
      ctx.fill();
    };

    canvas.addEventListener('mousedown', (e) => scratching = true);
    canvas.addEventListener('mouseup', (e) => scratching = false);
    canvas.addEventListener('mousemove', (e) => {
      if (scratching) scratch(e.offsetX, e.offsetY);
    });

    canvas.addEventListener('touchstart', (e) => scratching = true);
    canvas.addEventListener('touchend', (e) => scratching = false);
    canvas.addEventListener('touchmove', (e) => {
      if (scratching) {
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        scratch(touch.clientX - rect.left, touch.clientY - rect.top);
      }
    });

    // Auto-reveal after time
    setTimeout(() => {
      resultDiv.textContent = `${multiplier} Win: ${win} SOL`;
      tg.close();
    }, 15000);
  </script>
</body>
</html>
