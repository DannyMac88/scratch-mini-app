<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scratch Card Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { margin: 0; background: #f0f0f0; font-family: Arial; text-align: center; }
    canvas { border: 2px solid #333; background: #ccc; cursor: pointer; }
    #result { margin-top: 20px; font-size: 20px; color: green; display: none; }
    #instructions { margin: 10px; font-size: 16px; color: #333; }
    button { margin-top: 10px; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Scratch the Card!</h2>
  <p id="instructions">Scratch the gray area to reveal your win! Scratch at least 70% to see the result.</p>
  <canvas id="scratch" width="300" height="200"></canvas>
  <div id="result"></div>
  <button id="revealBtn" style="display: none;">Reveal Result</button>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const canvas = document.getElementById('scratch');
    const ctx = canvas.getContext('2d');
    const resultDiv = document.getElementById('result');
    const revealBtn = document.getElementById('revealBtn');

    const urlParams = new URLSearchParams(window.location.search);
    const multiplier = decodeURIComponent(urlParams.get('multiplier') || 'No Win This Time.');
    const win = urlParams.get('win') || '0';
    const userId = urlParams.get('userId') || '';

    // Draw dynamic outcome
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, 300, 200);
    ctx.fillStyle = '#000';
    ctx.font = '20px Arial';
    ctx.fillText(`${multiplier} Win: ${win} SOL`, 50, 100);

    // Scratch layer
    ctx.fillStyle = '#999';
    ctx.fillRect(0, 0, 300, 200);

    let scratching = false;
    let scratchedPixels = 0;
    const totalPixels = canvas.width * canvas.height;

    const scratch = (x, y) => {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(x, y, 15, 0, Math.PI * 2);
      ctx.fill();
      scratchedPixels += Math.PI * 15 * 15; // Approximate scratched area
      checkProgress();
    };

    canvas.addEventListener('mousedown', (e) => scratching = true);
    canvas.addEventListener('mouseup', (e) => scratching = false);
    canvas.addEventListener('mousemove', (e) => {
      if (scratching) scratch(e.offsetX, e.offsetY);
    });

    canvas.addEventListener('touchstart', (e) => scratching = true);
    canvas.addEventListener('touchend', (e) => scratching = false);
    canvas.addEventListener('touchmove', (e) => {
      if (scratching) {
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        scratch(touch.clientX - rect.left, touch.clientY - rect.top);
      }
    });

    // Check scratched progress
    function checkProgress() {
      const percentage = (scratchedPixels / totalPixels) * 100;
      if (percentage > 70) {
        revealResult();
      } else if (percentage > 50) {
        revealBtn.style.display = 'block';
      }
    }

    function revealResult() {
      resultDiv.textContent = `${multiplier} Win: ${win} SOL`;
      resultDiv.style.display = 'block';
      revealBtn.style.display = 'none';
      // Notify bot to send message
      fetch('https://vallecular-imputatively-memphis.ngrok-free.dev/notify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, multiplier, win })
      }).catch(err => console.error('Notify failed: ' + err.message));
      setTimeout(() => tg.close(), 5000); // Close after 5s
    }

    revealBtn.addEventListener('click', revealResult);
  </script>
</body>
</html>
