<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scratch Card Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { margin: 0; background: #f0f0f0; font-family: Arial; text-align: center; }
    canvas { border: 2px solid #333; background: #ccc; cursor: pointer; }
    #result { margin-top: 20px; font-size: 20px; color: green; }
    #instructions { margin: 10px; font-size: 16px; color: #333; }
  </style>
</head>
<body>
  <h2>Scratch the Card!</h2>
  <p id="instructions">Scratch the gray area to reveal your win! (Auto-reveals in 10s)</p>
  <canvas id="scratch" width="300" height="200"></canvas>
  <div id="result"></div>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const canvas = document.getElementById('scratch');
    const ctx = canvas.getContext('2d');
    const resultDiv = document.getElementById('result');

    const urlParams = new URLSearchParams(window.location.search);
    const multiplier = decodeURIComponent(urlParams.get('multiplier') || 'No Win This Time.');
    const win = urlParams.get('win') || '0';

    // Draw dynamic outcome
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, 300, 200);
    ctx.fillStyle = '#000';
    ctx.font = '20px Arial';
    ctx.fillText(`${multiplier} Win: ${win} SOL`, 50, 100);

    // Scratch layer
    ctx.fillStyle = '#999';
    ctx.fillRect(0, 0, 300, 200);

    let scratching = false;

    const scratch = (x, y) => {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(x, y, 15, 0, Math.PI * 2);
      ctx.fill();
      checkProgress();
    };

    canvas.addEventListener('mousedown', (e) => scratching = true);
    canvas.addEventListener('mouseup', (e) => scratching = false);
    canvas.addEventListener('mousemove', (e) => {
      if (scratching) scratch(e.offsetX, e.offsetY);
    });

    canvas.addEventListener('touchstart', (e) => scratching = true);
    canvas.addEventListener('touchend', (e) => scratching = false);
    canvas.addEventListener('touchmove', (e) => {
      if (scratching) {
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        scratch(touch.clientX - rect.left, touch.clientY - rect.top);
      }
    });

    // Check scratched progress
    function checkProgress() {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
      let scratchedPixels = 0;
      for (let i = 3; i < imageData.length; i += 4) {
        if (imageData[i] < 255) scratchedPixels++;
      }
      const percentage = (scratchedPixels / (canvas.width * canvas.height)) * 100;
      if (percentage > 70) {
        resultDiv.textContent = `${multiplier} Win: ${win} SOL`;
        tg.close();
      }
    }

    // Auto-reveal after time
    setTimeout(() => {
      resultDiv.textContent = `${multiplier} Win: ${win} SOL`;
      tg.close();
    }, 10000);
  </script>
</body>
</html>
