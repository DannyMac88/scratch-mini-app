<script>
  const tg = window.Telegram.WebApp;
  tg.ready();

  const canvas = document.getElementById('scratch');
  const ctx = canvas.getContext('2d');
  const resultDiv = document.getElementById('result');

  const urlParams = new URLSearchParams(window.location.search);
  const price = parseFloat(urlParams.get('price')) || 0.01;
  const theme = urlParams.get('theme') || 'FTX Collapse Card';

  let multiplier = 'No Win This Time.';
  let win = '0';

  // Wallet payment and API call
  if (window.solana && window.solana.isPhantom) {
    try {
      const response = await window.solana.connect();
      const userWallet = response.publicKey.toString();

      const connection = new Solana.Connection('https://api.mainnet-beta.solana.com', 'confirmed');
      const housePubkey = new Solana.PublicKey('EkxrH4sq9ezE2EQQcNpB3SxdkfNJvnzfZt9YN799MCPF');

      const transaction = new Solana.Transaction().add(
        Solana.SystemProgram.transfer({
          fromPubkey: response.publicKey,
          toPubkey: housePubkey,
          lamports: price * Solana.LAMPORTS_PER_SOL,
        })
      );

      const { signature } = await window.solana.signAndSendTransaction(transaction);
      await connection.confirmTransaction(signature, 'confirmed');

      // Call API for outcome
      const apiResponse = await fetch('https://vallecular-imputatively-memphis.ngrok-free.dev/get-outcome', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ txSig: signature, theme, userAddress: userWallet })
      });
      const data = await apiResponse.json();
      multiplier = data.multiplier;
      win = data.win;

      // Draw dynamic outcome
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, 300, 200);
      ctx.fillStyle = '#000';
      ctx.font = '20px Arial';
      ctx.fillText(`${multiplier} Win: ${win} SOL`, 50, 100);

      // Scratch layer
      ctx.fillStyle = '#999';
      ctx.fillRect(0, 0, 300, 200);
    } catch (err) {
      alert('Payment or API failed: ' + err.message);
      tg.close();
    }
  } else {
    alert('Install Phantom wallet!');
    tg.close();
  }

  // Scratching logic (keep your existing event listeners here)
  let scratching = false;

  const scratch = (x, y) => {
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(x, y, 15, 0, Math.PI * 2);
    ctx.fill();
  };

  canvas.addEventListener('mousedown', (e) => scratching = true);
  canvas.addEventListener('mouseup', (e) => scratching = false);
  canvas.addEventListener('mousemove', (e) => {
    if (scratching) scratch(e.offsetX, e.offsetY);
  });

  canvas.addEventListener('touchstart', (e) => scratching = true);
  canvas.addEventListener('touchend', (e) => scratching = false);
  canvas.addEventListener('touchmove', (e) => {
    if (scratching) {
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      scratch(touch.clientX - rect.left, touch.clientY - rect.top);
    }
  });

  // Auto-reveal result after time or full scratch
  setTimeout(() => {
    resultDiv.textContent = `${multiplier} Win: ${win} SOL`;
    tg.close();
  }, 15000);
</script>
